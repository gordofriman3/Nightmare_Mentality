   <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nightmare Mentality</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Mono&display=swap" rel="stylesheet">

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}

body {
    background: #290000;
    color: red; 
    font-family: 'Atkinson Hyperlegible Mono', monospace;
    transition: background 0.3s;
}

.hidden {
    display: none !important;
}

.scene {
    width: 100vw;
    min-height: 100vh;
}

/* MENU */
#menu {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
}

/* GAME */
#game {
    display: flex;
    flex-direction: column;
}

#stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    padding: 3px;
    border: 2px solid red;
    border-radius: 10px;
    box-shadow: 0 0 10px red;
}

#bottom {
    flex: 1;
    display: flex;
    margin: 10px;
    gap: 10px;
}

#think {
    flex: 1;
    border: 2px solid red;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 0 10px red;
}

#buttons {
    flex: 1;
    border: 2px solid red;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
    box-shadow: 0 0 10px red;
}

button {
    background: #3D0000;
    border: 2px solid red;
    color: red;
    padding: 20px 60px;
    font-size: 4vh;
    cursor: pointer;
    border-radius: 10px;
    box-shadow: 0px 0px 25px rgba(255, 0, 0, 0.5);
    font-family: 'Atkinson Hyperlegible Mono', monospace;
}

button:active {
    background: red;
    color: black;
}

button:disabled {
    opacity: 0.5;
}

#title {
    color: red;
    text-shadow:
    0 0 5px red,
    0 0 20px red,
    0 0 50px red,
    0 0 100px red,
    0 0 160px darkred;
    animation: glitch 0.2s infinite;
}
@keyframes glitch {
  0% { transform: translate(0); }
  20% { transform: translate(-2px, 2px)}
  40% { transform: translate(2px, -2px); }
  60% { transform: translate(-1px, 1px); }
  80% { transform: translate(1px, -1px); }
  100% { transform: translate(0, 0); }
}
@keyframes shake {
  0% { transform: translate(0, 0); }
  25% { transform: translate(-2px, 1px); }
  50% { transform: translate(2px, -1px); }
  75% { transform: translate(-1px, -2px); }
  100% { transform: translate(0); }
}

.low-health {
  animation: shake 0.2s infinite;
}
#decision {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 25px;
    padding: 20px;
}
#decisionContent {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
}
#jumpscare, #jumpscare2, #jumpscare3 {
    position: fixed;
    top: 0;
    left: 0;
    
    width: 100vw;
    height: 100vh;

    object-fit: cover;
    
    z-index: 9999;
}
.stat {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
}
.bar {
    width: 100%;
    height: 14px;
    background: #3D0000;
    border: 1px solid red;
    border-radius: 6px;
    overflow: hidden;
}
.bar div {
    height: 100%;
    width: 100%;
    background: darkred;
    transition: width 0.3s;
}
.healthbar {
    background: darkred;
}
#anxietybar {
    background: darkmagenta;
}
#energybar {
    background: #C4B000;
}
#itemImage {
    width: 180px;
}
#application {
    background: black;
    color: white;
}
#appButton {
    background: black;
    color: white;
    border: 2px solid white;
    border-radius: 10px;
    padding: 20px 60px;
    font-size: 4vh;
    margin-top: 65px;
    margin-left: 600px;
    box-shadow: none;
}
#timingbar {
position: relative;
    background: #290000;
    border: 2px solid red;
    border-radius: 10px;
    width: 700px;
    height: 40px;
    overflow: hidden;
}
#combate {
    display: flex;
    justify-content: center;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    gap: 20px;
}
#zone {
    position: absolute;
    background: green;
    height: 40px;
    width: 100px;
    top: 0px;
    left: 200px;
}
#cursor {
    position: absolute;
    background: white;
    height: 40px;
    width: 20px;
    top: 0px;
    left: 0px;
    animation: moveCursor 2s linear infinite;
}
@keyframes moveCursor {
    0%   { left: 0px}
    50% { left: 680px; }
    100%   { left: 0px}
}
#combate #healthbar {
    display: block;
    margin-bottom: 20px;
    background: darkred;
}
.healthbar {
    background: darkred;
}
#combatHUD {
    color: red;
    font-size: 18px;
}
#more {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
}
#credits {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}
.arsenalImage {
    width: 200px;
    }
    #arsenalBackBtn {
        top: 0px;
        left: 0px;
    }
    #imagediv {
    border-radius: 10px;
    padding: 10px;
    width: 225px;
    }
    #credits hr {
        height: 2px;
        background: red;
        margin: 20px 20px;
        border: none;
    }
    #modeSelect {
        display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    }
    #gameover {
        display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    }
    #youded {
        color: red;
    text-shadow:
    0 0 5px red,
    0 0 20px red,
    0 0 50px red,
    0 0 100px red,
    0 0 160px darkred;
    animation: glitch 0.2s infinite;
    }
    #difficultySelect {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    }
    #combate #attackBtn {
        position: fixed;
        bottom: 75px;
        left: 550px;
        z-index: 1000;
    }
    #arsenal #metalpipe {
        width: 500px;
    }
</style>
</head>

<body>

<div id="menu" class="scene hidden">
    <p>Alpha 4.3.0</p>
    <h1 id="title">NIGHTMARE MENTALITY</h1>
    <button id="startBtn">Empezar pesadilla</button>
    <button id="moreBtn">Mas</button>
</div>

<div id="game" class="scene hidden">
    <div id="stats">

        <div class="stat">
        <span id="health">Tu salud</span>
        <div class="bar">
            <div class="bar-fill healthbar"></div>
        </div>
        </div>

        <div class="stat">
        <span id="anxiety">Ansiedad</span>
        <div class="bar">
            <div class="bar-fill" id="anxietybar"></div>
        </div>
        </div>

        <div class="stat">
        <span id="energy">Energ√≠a</span>
        <div class="bar">
            <div class="bar-fill" id="energybar"></div>
            </div>
        </div>

        <div id="stat">
        <h4 id="distance">Distancia: 0 metros</h4>
        </div>
    </div>

    <div id="bottom">
        <div id="think">
            <h3>Pensamientos...</h3>
            <p>Tengo que llegar a la escuela, aunque tengo un raro presentimiento,
            como si algo me lo estuviera impidiendo...voy a tratar de resistir el mayor tiempo posible.</p>
        </div>

        <div id="buttons">
            <button id="advancebtn">Avanzar</button>
            <button id="defendBtn" disabled>Defenderse</button>
        </div>
    </div>
</div>
<div id="help" class="scene hidden">
    <button id="backBtn">Volver</button>
    <center><h1>Bienvenido a Nightmare Mentality</h1></center>
    <strong>Objetivo:</strong>
    <p>LLEGAR A LA ESCUELA CON VIDA.</p>
    <strong>Defensa:</strong>
    <p>Aca las armas son estrictamente limitadas, procura usarlas cuando no tengas escapatoria.</p>
    <strong>Salud:</strong>
    <p>No solamente hay que cuidarse y no recibir da√±o, si no que tambien hay que mantener nuestra energia
        estable, consumiendo grandes cantidades de azucar y cafeina. ademas tambien hay que tener en cuenta la salud mental, MUY IMPORTANTE.
    </p>
    <a href="https://www.tiktok.com/@el.gordo.friman?_r=1&_t=ZM-9359Tzuvyoe">Presion√° ac√° para apoyar el juego :)</a>
</div>
<div id="decision" class="scene hidden">
<img id="itemImage" class="hidden">
<h3 id="decisionMessage"></h3>
<button id="takeBtn">Tomar</button>
<button id="leaveBtn">Dejar</button>
</div>
<div id="application" class="scene">
<h1>Bienvenido a Nightmare Mentality</h1>
<p>Antes de empezar a jugar, solicitamos que sigan nuestras cuentas de TikTok,
    eso ayuda y apoya bastante al proyecto, para que crezca y se siga actualizando. Gracias
    por leer</p>
    <strong>Creador de el arte:</strong>
    <a href="https://www.tiktok.com/@1.panchili?_r=1&_t=ZS-93SL3xxOw5c">Click aqui para seguir.</a><br>
    <strong>Creador de los PNG:</strong>
    <a href="https://www.tiktok.com/@fzzz.250v16?_r=1&_t=ZS-93SL8eJ695x">Click aqui para seguir.</a><br>
    <strong>Creador y desarrollador:</strong>
    <a href="https://www.tiktok.com/@el.gordo.friman?_r=1&_t=ZS-93SL1CojHef">Click aqui para seguir.</a><br>
    <p>Recorda jugar con pantalla horizontal :)</p>
    <button id="appButton">Continuar</button>
</div>
<div id="combate" class="scene hidden">
    <div id="timingbar">
        <div id="zone"></div>
        <div id="cursor"></div>
        </div>
        <button id="attackBtn">Atacar</button>
        <div class="stat">
        <span id="health">Tu salud</span>
        <div class="bar">
            <div class="bar-fill healthbar"></div>
        </div>
        <div id="combatHUD" class="stat">
                <span id="combatAmmo"></span>
            </div>
        </div>
        </div>
<div id="more" class="scene hidden">
<button id="helpBtn">Ayuda</button>
<button id="creditsBtn">Creditos</button>
<button id="arsenalBtn">Arsenal</button>
<button id="menuBtn">Menu</button>
</div>
<div id="credits" class="scene hidden">
    <strong>Creador de el arte:</strong>
    <a href="https://www.tiktok.com/@1.panchili?_r=1&_t=ZS-93SL3xxOw5c">Click aqui para seguir.</a><br>
    <strong>Creador de los PNG:</strong>
    <a href="https://www.tiktok.com/@fzzz.250v16?_r=1&_t=ZS-93SL8eJ695x">Click aqui para seguir.</a><br>
    <strong>Creador y desarrollador:</strong>
    <a href="https://www.tiktok.com/@el.gordo.friman?_r=1&_t=ZS-93SL1CojHef">Click aqui para seguir.</a><br>
    <hr>
    <p>Lenguaje de programacion: Javascript</p>
    <p>Lenguaje de estructura: HTML</p>
    <p>Lenguaje de estilos: CSS</p>
    <p>Fuente de sonidos: <a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwjwkbKN97mSAxUUIrkGHViHKd8QFnoECAwQAQ&url=https%3A%2F%2Fpixabay.com%2Fes%2F&usg=AOvVaw0T0bO1xsf0x_iEAflKrotU&opi=89978449">Pixabay</a></p>
    <hr>
    <strong>Inspirado en:</strong>
    <p>Andreas R√∂nnberg (Cry of Fear - Afraid of Monsters)</p>
    <p>Keiichiro Toyama (Silent Hill)</p>
    <p>Shinji Mikami (Resident Evil/Biohazard)</p>
    <p>Miro Haverinen (Fear and Hunger)</p>
    <button id="creditsBackBtn">Volver</button>
</div>
<div id="arsenal" class="scene hidden">
    <button id="arsenalBackBtn">Volver</button>
    <center><strong><h1>Arsenal</h1></strong></center>
    <div id="imagediv">
    <img id="knife" src="assets/images/knife.png" class="arsenalImage">
    </div>
    <strong>Cuchillo:</strong><br>
    <p>Un cuchillo de cocina comun y corriente, algo desgastado por el uso, pero es mejor llevarlo que ir desarmado e indefenso. a pesar
         de ser de una arma no muy letal, no requiere de ningun tipo
    de municion, lo cual puede convertirse en un excelente arma si se controla tambien con habilidad y precision</p>
<div id="imagediv">
    <img id="makarovpm" src="assets/images/makarovpm.png" class="arsenalImage">
</div>
<strong>Makarov PM:</strong>
<p>Una pistola semiautomatica, originaria de las fuerzas armadas de la union sovietica, caracterizada por su 
    simplifidad y su tama√±o compacto. Se usa mayormente para realizar disparos precisos a larga distancia hacia el objetivo.
     a juzgar por su apariencia de desgastamiento, se puede decir que es demasiado
    antigua.</p>
<div id="imagediv">
    <img id="sawedoff" src="assets/images/sawedoff.png" class="arsenalimage">
    </div>
    <strong>Escopeta recortada:</strong>
    <p>La escopeta recortada, tambien muy llamada "Sawed-off", se caracteriza principalmente por su corta longitud de el ca√±on, provocando
        que al disparar, la dispercion de perdigones sea considerablemente mayor, aumentando su letalidad a corta distancia.
         Se usa comunmente para para cazar animales, como las aves o mamiferos peque√±os.
    </p>
    <div id="imagediv">
    <img id="metalpipe" src="assets/images/metalpipe.png" class="arsenalimage">
    </div>
    <strong>Tubo oxidado:</strong>
    <p>Un viejo tubo de ca√±eria de aproximadamente metro y medio de longitud, algo pesada. esta lleno de polvo y oxido, lo cual la hace propensa a 
        romperse. Un golpe con fuerza con este tubo, es letal debido a su dureza y facilidad de manipular, ademas, debido a su longitud, puede alcanzar facilmente al objetivo a una distancia media.
    </p>
</div>
<div id="modeSelect" class="scene hidden">
    <h1>Selecciona modo de juego.</h1>
    <button id="survivalBtn">Supervivencia</button>
    <small>Modo de juego infinito.</small>
    <button id="campaign" disabled>Campa√±a</button>
    <small>Modo de juego en desarrollo.</small>
</div>
<div id="gameover" class="scene hidden">
    <h1 id="youded">HAS MUERTO</h1>
    <button id="restartbtn">Reiniciar</button>
    <button id="mainMenuBtn">Menu</button>
</div>
<div id="difficultySelect" class="scene hidden">
    <h1>Selecciona dificultad.</h1>
    <button id="originalBtn">Original</button>
    <button id="avanzadoBtn">Avanzado</button>
</div>
<audio id="punch" src="assets/sounds/punch.mp3"></audio>
<audio id="knifesound" src="assets/sounds/knife.mp3"></audio>
<audio id="makarovsound" src="assets/sounds/pistolshot.mp3"></audio>
<audio id="sawedoffsound" src="assets/sounds/sawedoffshot.mp3"></audio>
<audio id="bandageput" src="assets/sounds/bandageput.mp3"></audio>
<audio id="takeammo" src="assets/sounds/ammo.mp3"></audio>
<audio id="pills" src="assets/sounds/pills.mp3"></audio>
<audio id="opencan" src="assets/sounds/monstercan.mp3"></audio>
<audio id="medkit" src="assets/sounds/medkitexhale.mp3"></audio>
<audio id="buttonclick" src="assets/sounds/button.mp3"></audio>
<audio id="heartbeat" src="assets/sounds/heartbeat.mp3"></audio>
<audio id="moan" src="assets/sounds/moan.mp3"></audio>
<audio id="whisper" src="assets/sounds/whisper.mp3" loop></audio>
<audio id="walk" src="assets/sounds/walk.mp3"></audio>
<audio id="takegun" src="assets/sounds/takegun.mp3"></audio>
<audio id="takeknife" src="assets/sounds/takeknife.mp3"></audio>
<audio id="damage" src="assets/sounds/damage.mp3"></audio>
<audio id="menuambience" src="assets/sounds/mainmenu.mp3"></audio>
<audio id="tensebeat" src="assets/sounds/tensebeat.mp3" loop></audio>
<audio id="JumpscareSound" src="assets/sounds/jumpscare.mp3"></audio>
<audio id="hit" src="assets/sounds/hit.mp3"></audio>
<audio id="moremusic" src="assets/sounds/moremusic.mp3"></audio>
<audio id="night" src="assets/sounds/night.mp3" loop></audio>
<audio id="brokenglass" src="assets/sounds/brokenglass.mp3"></audio>
<audio id="scream" src="assets/sounds/scream.mp3"></audio>
<audio id="pipeswish" src="assets/sounds/pipeswish.mp3"></audio>

<img id="jumpscare" src="assets/images/jumpscare.jpg" class="hidden">
<img id="bandage" src="assets/images/bandage.png" class="hidden">
<img id="clonazepampills" src="assets/images/clonazepam.png" class="hidden">
<img id="knifepng" src="assets/images/knife.png" class="hidden">
<img id="medkitpng" src="assets/images/medkit.png" class="hidden">
<img id="monster" src="assets/images/monster.png" class="hidden">
<img id="makarovpm" src="assets/images/makarovpm.png" class="hidden">
<img id="knife" src="assets/images/knife.png" class="hidden">
<img id="sawedoff" src="assets/images/sawedoff.png" class="hidden">
<img id="jumpscare2" src="assets/images/jumpscare2.webp" class="hidden">
<img id="jumpscare3" src="assets/images/jumpscare3.webp" class="hidden">
<img id="metalpipe" src="assets/images/metalpipe.png" class="hidden">
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("JS CARGADO");

    /* ELEMENTOS */
    const advancedBtn = document.getElementById("avanzadoBtn");
    const originalBtn = document.getElementById("originalBtn");
    const moreBtn = document.getElementById("moreBtn");
    const arsenalBtn = document.getElementById("arsenalBtn");
    const creditsBtn = document.getElementById("creditsBtn");
    const menuBtn = document.getElementById("menuBtn");
    const attackBtn = document.getElementById("attackBtn");
    const defendBtn = document.getElementById("defendBtn");
    const appButton = document.getElementById("appButton");
    const decisionMessage = document.getElementById("decisionMessage");
    const itemImage = document.getElementById("itemImage");
    const healthBars = document.querySelectorAll(".healthbar");
    const energyBar = document.getElementById("energybar");
    const anxietyBar = document.getElementById("anxietybar")
    const startBtn = document.getElementById("startBtn");
    const advanceBtn = document.getElementById("advancebtn");
    const distanceText = document.getElementById("distance");
    const energyText = document.getElementById("energy");
    const healthText = document.getElementById("health");
    const thinkBox = document.getElementById("think");
    const menuScene = document.getElementById("menu");
    const gameScene = document.getElementById("game");
    const restartBtn = document.getElementById("restartbtn")
    const anxietyText = document.getElementById("anxiety");
    const helpBtn = document.getElementById("helpBtn");
    const backBtn = document.getElementById("backBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const takeBtn = document.getElementById("takeBtn")
    const sounds = {
        "Scream": document.getElementById("scream"),
        "BrokenGlass": document.getElementById("brokenglass"),
        "Night": document.getElementById("night"),
        "MoreMusic": document.getElementById("moremusic"),
        "Hit": document.getElementById("hit"),
        "JumpscareSound": document.getElementById("JumpscareSound"),
        "Tension": document.getElementById("tensebeat"),
        "Menu Ambiente": document.getElementById("menuambience"),
        "Damage": document.getElementById("damage"),
        "Walk": document.getElementById("walk"),
        "Whisper": document.getElementById("whisper"),
        "Death": document.getElementById("moan"),
        "lowhealth": document.getElementById("heartbeat"),
        "Button": document.getElementById("buttonclick"),
        "Clonazepam": document.getElementById("pills"),
        "Vendaje": document.getElementById("bandageput"),
        "Botiquin": document.getElementById("medkit"),
        "Monster Energy": document.getElementById("opencan"),
        "Cuchillo": document.getElementById("knifesound"),
        "Makarov PM": document.getElementById("makarovsound"),
        "Escopeta recortada": document.getElementById("sawedoffsound"),
        "Tubo oxidado": document.getElementById("pipeswish"),
        punch: document.getElementById("punch"),
        takeWeapon: document.getElementById("takegun"),
        takeAmmo: document.getElementById("takeammo"),
        takeKnife: document.getElementById("takeknife")
    }
    const itemImages = {
    "Vendaje": "bandage.png",
    "Monster Energy": "monster.png",
    "Clonazepam": "clonazepam.png",
    "Botiquin": "medkit.png"
}; 
    
    /* ESTADO DEL JUEGO */
    let ammoInventory = {
        "Makarov PM": 0,
        "Escopeta recortada": 0
    };
    let enemies = [];
    let dificultad = "normal";
    let tensebeatPlaying = false;
    let distance = 0;
    let energy = 100;
    let health = 100;
    let enemyAlive = false;
    let enemyHealth = 0;
    let gameActive = true;
    let energyInterval;
    let equippedWeapon = null;
    let advanceCooldown = false;
    let anxiety = 0;
    let anxietyDamageInterval = null;
    let anxietyInterval;
    let currentEnemy = null;
    let pendingItem = null;
    let canAttack = true;
    let attackCooldownTimeout = null;
    let whisperPlaying = false;

    const ambientScares = [
        sounds["BrokenGlass"],
        sounds["Scream"],
    ]
    const jumpscares = [
        "jumpscare.jpg",
        "jumpscare2.webp",
        "jumpscare3.webp"];
    const jumpframes = [
        "jumpscare.jpg",
        "jumpscare2.webp",
        "jumpscare3.webp"];
    const ammo = [
        { name: "Cargador", amount: 8, weaponId: "Makarov PM", image: "clip.png", type: "ammo" },
        { name: "Cartuchos", amount: 2, weaponId: "Escopeta recortada", image: "shells.png", type: "ammo" },
        ];
    const weapons = [
        { name: "Tubo oxidado", damage: 30, cooldown: 800, image: "metalpipe.png", usesAmmo: false },
        { name: "Cuchillo", damage: 20, cooldown: 600, image: "knife.png", usesAmmo: false },
        { name: "Makarov PM", damage: 25, cooldown: 400, ammo: 8, image: "makarovpm.png", usesAmmo: true },
        { name: "Escopeta recortada", damage: 50, cooldown: 1000, ammo: 2, image: "sawedoff.png", usesAmmo: true },
     ];
    const items = ["Vendaje", "Monster Energy", "Clonazepam", "Botiquin"]
    
    function getEnemigosPorDificultad() {
    if (dificultad === "original") {
        return [
            {
                name: "La sombra",
                hp: 100,
                damage: 10,
                minDist: 0,
                maxDist: 1200,
                attackChance: 1
            },
            {
                name: "El bloqueador",
                hp: 125,
                damage: 30,
                minDist: 800,
                maxDist: 1200,
                attackChance: 1
            },
            {
                name: "El acechante",
                hp: 150,
                damage: 15,
                minDist: 400,
                maxDist: 1200,
                attackChance: 0.5
            }
        ];
    } else if (dificultad === "avanzado") {
        return [
            {
                name: "La sombra",
                hp: 150,  // +50%
                damage: 15, // +50%
                minDist: 0,
                maxDist: 1200,
                attackChance: 1
            },
            {
                name: "El bloqueador",
                hp: 188,  // +50%
                damage: 45, // +50%
                minDist: 800,
                maxDist: 1200,
                attackChance: 1
            },
            {
                name: "El acechante",
                hp: 225,  // +50%
                damage: 23, // +50%
                minDist: 400,
                maxDist: 1200,
                attackChance: 0.5
            }
        ];
    }
}

    /* FUNCIONES */
    function getEnemyByDistance(distance) {
    const enemigos = getEnemigosPorDificultad();
    const posibles = enemigos.filter(e =>
        distance >= e.minDist && distance <= e.maxDist
    );

    if (posibles.length === 0) return null;

    return posibles[Math.floor(Math.random() * posibles.length)];
}
    function iniciarJuego() {
    changeScene('game');
    updateUI();
    startEnergyRecovery();
    startAnxietyRecovery();
    startMaxAnxietyDamage();
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
    
    const ambience = sounds["Ambience"];
    const night = sounds["Night"];
    const moremusic = sounds["MoreMusic"];

    if (ambience.paused) {
        ambience.volume = 0.5;
        ambience.currentTime = 0;
        ambience.play();
    }
    if (night.paused) {
        night.volume = 1.0;
        night.currentTime = 0;
        night.play();
    }
    if (moremusic.paused) {
        moremusic.volume = 1.0;
        moremusic.currentTime = 0;
        moremusic.play();
    }
}
    function tryAmbientSound() {
    if (Math.random() < 0.05) { // 8% de probabilidad
        const sound = randomFrom(ambientScares);
        if (!sound) return;

        sound.currentTime = 0;
        sound.play();
    }
}
    function updateCombatAmmo() {
    const ammoText = document.getElementById("combatAmmo");

    if (equippedWeapon && equippedWeapon.usesAmmo) {
        ammoText.textContent = `Munici√≥n: ${equippedWeapon.ammo}`;
    } else {
        ammoText.textContent = ""; // no mostrar nada
    }
}
    function randomizarZona() {
    const timingbar = document.getElementById("timingbar");
    const zone = document.getElementById("zone");

    const barWidth = timingbar.clientWidth;
    const zoneWidth = zone.clientWidth;

    const maxLeft = barWidth - zoneWidth;
    const randomLeft = Math.random() * maxLeft;

    zone.style.left = randomLeft + "px";
}
    function cursorEnZona() {
    const cursor = document.getElementById("cursor");
    const zone = document.getElementById("zone");

    const cursorRect = cursor.getBoundingClientRect();
    const zoneRect = zone.getBoundingClientRect();

    return (
        cursorRect.left >= zoneRect.left &&
        cursorRect.right <= zoneRect.right
    );
}
    function randomFrom(array) {
    return array[Math.floor(Math.random() * array.length)];
}

function showImage(imgName, duration) {
    const imgElement = document.getElementById("jumpscare");
    imgElement.src = `assets/images/${imgName}`;
    imgElement.classList.remove("hidden");

    setTimeout(() => {
        imgElement.classList.add("hidden");
    }, duration);
}
    function tryJumpscare() {
  // probabilidad base de jumpframe normal
  if (Math.random() < 0.10) {
    showjumpframe();
  }

  // jumpscare completo SOLO con ansiedad alta
  if (anxiety >= 70 && Math.random() < 0.30) {
    showjumpscare();
  }
}
    function showjumpframe() {
  const img = randomFrom(jumpframes);
  showImage(img, 80); // duraci√≥n corta
}
function showjumpscare() {
  const img = randomFrom(jumpscares);

  showImage(img, 800); // dura m√°s
  JumpscareSound.currentTime = 0;
  JumpscareSound.play();

  health -= 10;
  if (health < 0) health = 0;

  updateUI();
}
    function startMaxAnxietyDamage() {
    clearInterval(anxietyDamageInterval);

    anxietyDamageInterval = setInterval(() => {
        if (!gameActive) return;

        if (anxiety >= 90) {
            health -= 1;
            if (health < 0) health = 0;

            if (sounds["Damage"]) {
                sounds["Damage"].currentTime = 0;
                sounds["Damage"].play();

            }

            updateUI();

            // muerte por ansiedad
            if (health <= 0) {
                gameActive = false;
                advanceBtn.disabled = true;
                attackBtn.disabled = true;
                restartBtn.disabled = false;
                defendBtn.disabled = true;

                sounds["Death"].currentTime = 0;
                sounds["Death"].play();

                changeScene('gameover');
            }
        }
    }, 2000); // cada 3 segundos
}
function triggerEnding() {
    gameActive = false;

    thinkBox.style.display = "block";
    thinkBox.innerHTML = `
        <p>No puedo creer que haya llegado... Con vida.</p>
        <br>
        <p>Gracias por jugar :)</p>
        <br>
        <p><strong>Desarrollado por:</strong> El Friman</p>
        <p><strong>Dibujos hechos por:</strong> Lichi the creator</p>
        <p><strong>PNG hechos por:</strong> Tito Furioso</p>
    `;

    stopAllSounds();
    stopScreenShake();
}
    function addAmmo(ammoItem) {
  if (!equippedWeapon) return;

  if (equippedWeapon.id !== ammoItem.weaponId) return;

  equippedWeapon.ammo += ammoItem.amount;
  equippedWeapon.ammo = Math.min(
    equippedWeapon.ammo,
    equippedWeapon.maxAmmo
  );
}
    function playItemSound(itemName) {
    const sound = sounds[itemName];
    if (!sound) return;

    sound.currentTime = 0;
    sound.play();
}
    function playAttackSound() {
        let sound;

        if (equippedWeapon) {
            sound = sounds[equippedWeapon.name];
        } else {
            sound = sounds.punch;
        }
        if (!sound) return;

        sound.currentTime = 0;
        sound.play();
    }
    function ataqueAutomaticoEnemigo() {
    if (!enemyAlive || !gameActive || !currentEnemy) return;
    
    // El enemigo ataca
    health -= currentEnemy.damage;
    
    flashBackground("#570000");
    if (sounds.Damage) {
        sounds.Damage.currentTime = 0;
        sounds.Damage.play();
    }
    
    // Verificar muerte
    if (health <= 0) {
        health = 0;
        gameActive = false;
        advanceBtn.disabled = true;
        attackBtn.disabled = true;
        restartBtn.disabled = false;
        defendBtn.disabled = true;
        clearInterval(energyInterval);
        sounds["Death"].currentTime = 0;
        sounds["Death"].play();
        changeScene('gameover');
    }
    
    updateUI();
    
    // Programar pr√≥ximo ataque (si sigue vivo)
    if (enemyAlive && gameActive && health > 0) {
        setTimeout(() => {
            ataqueAutomaticoEnemigo();
        }, 5000);
    }
}
    function startAttackCooldown(time) {
    canAttack = false;
    attackBtn.disabled = true;

    clearTimeout(attackCooldownTimeout);
    attackCooldownTimeout = setTimeout(() => {
        if (enemyAlive && gameActive) {
            canAttack = true;
            attackBtn.disabled = false;
        }
    }, time);
}
    function getEnemyChance() {
    if (anxiety < 40) return 0.10;
    if (anxiety < 70) return 0.20;
    return 0.30;
}
function playWhisper() {
    if (anxiety >= 40 && !whisperPlaying) {
        sounds["Whisper"].loop = true;
        sounds["Whisper"].volume = 1.0;
        sounds["Whisper"].play();
        whisperPlaying = true;
    }

    if (anxiety < 40 && whisperPlaying) {
        sounds["Whisper"].pause();
        sounds["Whisper"].currentTime = 0;
        whisperPlaying = false;
    }
}
function playTension() {
    if (anxiety >= 70 && !tensebeatPlaying) {
        sounds["Tension"].loop = true;
        sounds["Tension"].volume = 1.0;
        sounds["Tension"].play();
        tensebeatPlaying = true;
    }

    if (anxiety < 70 && tensebeatPlaying) {
        sounds["Tension"].pause();
        sounds["Tension"].currentTime = 0;
        tensebeatPlaying = false;
    }
}
    function changeScene(id) {
        document.querySelectorAll('.scene').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function updateUI() {
        distanceText.textContent = `Distancia: ${distance} metros`;

        energyText.textContent = `Energ√≠a`;
        healthText.textContent = `Salud`;
        anxietyText.textContent = `Ansiedad`;

        healthBars.forEach(bar => {
    bar.style.width = health + "%";
});
        anxietyBar.style.width = anxiety + "%";
        energyBar.style.width = energy + "%";

        playWhisper();
        playTension();

    if (health <= 20 && gameActive) {
        document.body.classList.add("low-health");

        if (sounds["lowhealth"].paused) {
            sounds["lowhealth"].currentTime = 0;
            sounds["lowhealth"].play();
        }
    } else {
        document.body.classList.remove("low-health");
        sounds["lowhealth"].pause();
        sounds["lowhealth"].currentTime = 0;
    }
}
    function flashBackground(color) {
        const original = document.body.style.background;
        document.body.style.background = color;
        setTimeout(() => document.body.style.background = original, 400);
    }
    function encontrarObjeto() {
        const rand = Math.random();
        const isWeapon = rand < 0.25; // 25% de chance
        const isAmmo = rand >= 0.25 && rand < 0.40; // 15% de chance (25 a 40)
        
        if (isWeapon) {
            pendingItem = {
                type: "weapon",
                data: weapons[Math.floor(Math.random() * weapons.length)]
            };
            } else if (isAmmo) {
                pendingItem = {
                    type: "ammo",
                    data: ammo[Math.floor(Math.random() * ammo.length)]
                };
                } else {
                pendingItem = {
                    type: "item",
                    data: items[Math.floor(Math.random() * items.length)]
                };
                }
            abrirDecision();
            }

            function aplicarPendingItem() {
    if (!pendingItem) return;

    if (pendingItem.type === "weapon") {
        equippedWeapon = { ...pendingItem.data };

        // SONIDO SEG√öN EL ARMA
        if(equippedWeapon.name === "Tubo oxidado") {
            if (sounds.takeKnife) {
                sounds.takeKnife.currentTime = 0;
                sounds.takeKnife.play();
                }
            } else if (equippedWeapon.name === "Cuchillo") {
            if (sounds.takeKnife) {
                sounds.takeKnife.currentTime = 0;
                sounds.takeKnife.play();
            }
        } else {
            // Sonido para armas de fuego
            if (sounds.takeWeapon) {
                sounds.takeWeapon.currentTime = 0;
                sounds.takeWeapon.play();
            }
        }
        
        // MUNICI√ìN PARA ARMAS DE FUEGO
        if (equippedWeapon.usesAmmo) {
            // El arma viene con su carga inicial
            const cargaInicial = pendingItem.data.ammo || 0;
            
            // Verificar si tenemos munici√≥n en el inventario
            const ammoInInventory = ammoInventory[equippedWeapon.name] || 0;
            
            if (ammoInInventory > 0) {
                // Si hay munici√≥n en inventario, sumar a la carga inicial
                equippedWeapon.ammo = cargaInicial + ammoInInventory;
                ammoInventory[equippedWeapon.name] = 0; // Vaciar inventario
                thinkBox.innerHTML = `<p>Ahora tengo ${equippedWeapon.name} con ${equippedWeapon.ammo} balas (carga inicial + inventario).</p>`;
            } else {
                // Si no hay munici√≥n, usar solo la carga inicial
                equippedWeapon.ammo = cargaInicial;
                thinkBox.innerHTML = `<p>Ahora tengo ${equippedWeapon.name} con ${equippedWeapon.ammo} balas (carga inicial).</p>`;
            }
        } else {
            // Para el cuchillo (no usa munici√≥n)
            thinkBox.innerHTML = `<p>Ahora tengo un ${equippedWeapon.name}. Podr√≠a ser √∫til en combate cercano.</p>`;
        }
        
        flashBackground("#0036B5");
    } 
    else if (pendingItem.type === "ammo") {
        // Aqu√≠ manejamos la munici√≥n encontrada
        const ammoItem = pendingItem.data;
        
        // SUMAR AL INVENTARIO (siempre)
        if (!ammoInventory[ammoItem.weaponId]) {
            ammoInventory[ammoItem.weaponId] = 0;
        }
        ammoInventory[ammoItem.weaponId] += ammoItem.amount;

        // SONIDO DE MUNICI√ìN
        if (sounds.takeAmmo) {
            sounds.takeAmmo.currentTime = 0;
            sounds.takeAmmo.play();
        }
        
        // Verificar si tenemos un arma que use esta munici√≥n
        if (equippedWeapon && equippedWeapon.name === ammoItem.weaponId) {
            // Si tenemos el arma equipada, sumar directamente
            equippedWeapon.ammo += ammoItem.amount;
            thinkBox.innerHTML = `<p>Encontr√© ${ammoItem.name}. ${equippedWeapon.name}: ${equippedWeapon.ammo} balas.</p>`;
            flashBackground("#7F7F00");
        }
        else {
            // Si no tenemos el arma, guardar en inventario
            thinkBox.innerHTML = `<p>Encontr√© ${ammoItem.name}. Guardado en el inventario (${ammoInventory[ammoItem.weaponId]} disponibles).</p>`;
            flashBackground("#7F7F00");
        }
    }
    else if (pendingItem.type === "item") {
        const item = pendingItem.data;

        if (item === "Botiquin") {
            health = Math.min(health + 30, 100);
            thinkBox.innerHTML = "<p>Encontr√© un botiqu√≠n, recuper√© mi salud como se debe, que alivio.</p>";
            flashBackground("#03B500");
            playItemSound("Botiquin");
        } 
        else if (item === "Vendaje") {
            health = Math.min(health + 10, 100);
            thinkBox.innerHTML = "<p>Encontr√© un vendaje, por el momento me sirve para resistir un poco el dolor...</p>";
            flashBackground("#649412");
            playItemSound("Vendaje");
        }
        else if (item === "Monster Energy") {
            energy = Math.min(energy + 100, 100);
            thinkBox.innerHTML = "<p>Una Monster, esto me da un impulso de energ√≠a, mi cuerpo puede avanzar con facilidad.</p>";
            flashBackground("#B5B500");
            playItemSound("Monster Energy");
        }
        else if (item === "Clonazepam") {
            anxiety = Math.max(anxiety - 30, 0);
            thinkBox.innerHTML = "<p>Encontr√© Clonazepam, unas pastillas para la ansiedad, me siento m√°s relajado moment√°neamente.</p>";
            flashBackground("#7F00E0");
            playItemSound("Clonazepam");
        }
    }
    
    updateUI();
}
    function abrirDecision() {
    let nombre;
    let imageSrc;

        if (pendingItem.type === "weapon") {
        nombre = pendingItem.data.name;
        imageSrc = `assets/images/${pendingItem.data.image}`;
    } else if (pendingItem.type === "ammo") {
        nombre = pendingItem.data.name;
        imageSrc = `assets/images/${pendingItem.data.image}`;
    } else {
        nombre = pendingItem.data;
        imageSrc = `assets/images/${itemImages[nombre]}`;
    }

    itemImage.src = imageSrc;
    itemImage.classList.remove("hidden");
    decisionMessage.textContent = `¬øTomar ${nombre}?`;
    changeScene("decision");
}
    function startEnergyRecovery() {
        clearInterval(energyInterval);
        energyInterval = setInterval(() => {
            if (!enemyAlive && energy < 100 && gameActive) {
                energy += 1;
                updateUI();
            }
        }, 600);
    }
    function startAnxietyRecovery() {
        clearInterval(anxietyInterval);
        anxietyInterval = setInterval(() => {
            if (gameActive && anxiety < 100) {
                anxiety += 1;
                updateUI();
            }
        }, 600);
    }
    function resetGame() {
    // Estado base
    distance = 0;
    energy = 100;
    health = 100;
    enemyAlive = false;
    enemyHealth = 0;
    gameActive = true;
    equippedWeapon = null;
    advanceCooldown = false;
    anxiety = 0;
    ammoInventory= {
        "Makarov PM": 0,
        "Escopeta recortada": 0
    };

    updateUI();

    thinkBox.innerHTML = `
        <h3>Pensamientos...</h3>
<p>Tengo que llegar a la escuela, aunque tengo un raro presentimiento,
            como si algo me lo estuviera impidiendo...voy a tratar de resistir el mayor tiempo posible.</p>`;

    advanceBtn.disabled = false;
    attackBtn.disabled = true;
    restartBtn.disabled = true;
    defendBtn.disabled = true;

    startEnergyRecovery();
    
    startAnxietyRecovery();

    startMaxAnxietyDamage();
}
    /* EVENTOS */
    document.getElementById('originalBtn').addEventListener('click', () => {
    dificultad = "normal";
    sounds["Night"].loop = true;
        sounds["Night"].volume = 1.0;
        sounds["Night"].play();
    iniciarJuego();
});

document.getElementById('avanzadoBtn').addEventListener('click', () => {
    dificultad = "avanzado";
    sounds["Night"].loop = true;
        sounds["Night"].volume = 1.0;
        sounds["Night"].play();
    iniciarJuego();
});
   mainMenuBtn.addEventListener('click', () => {
        resetGame();
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
        changeScene('menu');
        updateUI();
        const menuambience = sounds["Menu Ambiente"];

    menuambience.currentTime = 0;
    menuambience.play();
});
    startBtn.addEventListener('click', () => {
        changeScene('modeSelect');
        
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
});
    arsenalBackBtn.addEventListener('click', () => {
        changeScene('more');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
});
    creditsBackBtn.addEventListener('click', () => {
        changeScene('more');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
});
    menuBtn.addEventListener('click', () => {
        changeScene('menu');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();

        menuambience.currentTime = 0;
    menuambience.play();
        });
    arsenalBtn.addEventListener('click', () => {
        changeScene('arsenal');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
        });
    creditsBtn.addEventListener('click', () => {
        changeScene('credits');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
        });
    moreBtn.addEventListener('click', () => {
        changeScene('more');
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();

    moremusic.play();
        });
    defendBtn.addEventListener('click', () => {
        changeScene('combate');

        sounds["Button"].currentTime = 0;
        sounds["Button"].play();

        canAttack = true;
        attackBtn.disabled = false;

        setTimeout(() => {
            randomizarZona();
        }, 50);

        updateCombatAmmo()
        updateUI();
    });
    appButton.addEventListener('click', () => {
    changeScene('menu');
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
    updateUI();
    const menuambience = sounds["Menu Ambiente"];

    menuambience.currentTime = 0;
    menuambience.play();
    });
    leaveBtn.addEventListener("click", () => {
        thinkBox.innerHTML = `<p>Decidio no tomar ${pendingItem.data.name || pendingItem.data}.</p>`;
        pendingItem = null;
        changeScene("game")
        sounds["Button"].currentTime = 0;
        sounds["Button"].play();
    });
    takeBtn.addEventListener("click", () => {
        aplicarPendingItem();
        pendingItem = null;
        changeScene("game")
    });
    restartBtn.addEventListener('click', () => {
    resetGame();
    canAttack = true;
    canDefend = true;
    clearTimeout(attackCooldownTimeout);
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
    changeScene('game');
});
helpBtn.addEventListener('click', () => {
    changeScene('help');
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
    updateUI();
});
backBtn.addEventListener('click', () => {
    changeScene('more');
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
    updateUI();
    const menuambience = sounds["Menu Ambiente"];
})
    survivalBtn.addEventListener('click', () => {
    changeScene('difficultySelect');  // Cambia a selecci√≥n de dificultad
    sounds["Button"].currentTime = 0;
    sounds["Button"].play();
});

    advanceBtn.addEventListener('click', () => {
    if (!gameActive || energy <= 0 || enemyAlive) return;
    if (advanceCooldown) return;

    sounds["Walk"].currentTime = 0;
    sounds["Walk"].play();

    advanceCooldown = true;
    advanceBtn.disabled = true;

    setTimeout(() => {
        advanceCooldown = false;
        if (gameActive && !enemyAlive) {
            advanceBtn.disabled = false;
        }
    }, 1000);

    const ITEM_CHANCE = 0.20;

    if (Math.random() < ITEM_CHANCE) {
        encontrarObjeto();
        return;
    }

    distance += 20;
    energy -= 10;

    if (distance >= 1200 && gameActive) {
        triggerEnding();
    }


    const enemy = getEnemyByDistance(distance);
    const enemyChance = getEnemyChance();

    if (enemy && Math.random() < enemyChance && Math.random() < enemy.attackChance) {
    enemyAlive = true;
    enemyHealth = enemy.hp;
    currentEnemy = enemy;

    canAttack = true;
    attackBtn.disabled = false;
    advanceBtn.disabled = true;
    defendBtn.disabled = false;

    // USAR UNA VARIABLE LOCAL
    let mensajeHTML = `
        <h3>Peligro</h3>
        <p>${enemy.name} aparece frente a m√≠‚Ä¶ no puedo avanzar (Pulsa atacar para defenderte)</p>`;

    if (equippedWeapon && equippedWeapon.usesAmmo) {
        mensajeHTML += `<br>${equippedWeapon.name}: ${equippedWeapon.ammo} balas`;
    }
    
    thinkBox.innerHTML = mensajeHTML;
    
    // EL ENEMIGO SIEMPRE ATACAR√Å AUTOM√ÅTICAMENTE, SIN IMPORTAR EL ARMA
    setTimeout(() => {
        if (enemyAlive && gameActive && currentEnemy) {
            ataqueAutomaticoEnemigo();
        }
    }, 5000); // Primer ataque en 1 segundo
    
} else {
    thinkBox.innerHTML = "<p>Sigo avanzando entre la oscuridad y la soledad...</p>";
}
tryAmbientSound();
tryJumpscare();
    updateUI();
});

    attackBtn.addEventListener('click', () => {
    if (!gameActive || !canAttack) return;

    playAttackSound();

    const weapon = equippedWeapon;
    const usesAmmo = weapon && weapon.usesAmmo;

    // üî´ CONSUMIR MUNICI√ìN SI DISPARA (ACIERTE O FALLO)
    if (usesAmmo) {
        weapon.ammo--;
        updateCombatAmmo();

        if (weapon.ammo <= 0) {
            thinkBox.innerHTML = `
                <p>
Mi ${weapon.name} se qued√≥ sin munici√≥n,
lo voy a tener que abandonar.
                </p>
            `;
            equippedWeapon = null;
            updateCombatAmmo();
        }
    }

    // ‚ùå FALLO
    if (!cursorEnZona()) {
        flashBackground("#3b0000");
        health -= currentEnemy.damage; // castigo real
        updateUI();
    }

    // ‚úÖ ACIERTO
    sounds["Hit"].currentTime = 0;
    sounds["Hit"].play();

    const playerDamage = weapon ? weapon.damage : 10;
    const cooldown = weapon ? weapon.cooldown : 500;

    enemyHealth -= playerDamage;

    startAttackCooldown(cooldown);

    if (enemyHealth <= 0) {
        enemyAlive = false;
        attackBtn.disabled = true;
        advanceBtn.disabled = false;
        defendBtn.disabled = true;
        thinkBox.innerHTML = "<p>El monstruo ya no se mueve, estoy algo herido, pero puedo seguir.</p>";
        changeScene('game');
    }

    if (health <= 0) {
        gameActive = false;
        restartBtn.disabled = false;
        clearInterval(energyInterval);
        sounds["Death"].currentTime = 0;
        sounds["Death"].play();
        changeScene('gameover');
    }

    updateUI();
    return;
});

});
</script>
</body>
</html>
